const OpenAI = require("openai");
const dotenv = require("dotenv");

// í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ (.env íŒŒì¼ í•„ìš”)
dotenv.config();

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY, // .env íŒŒì¼ì— API í‚¤ ì €ì¥ í•„ìš”
});

async function askOpenAI(prompt,speakerNames, mindMap = null) {
  try {
    if (!prompt) return;

    // ğŸ“ mindMap ë°ì´í„° ì—¬ë¶€ì— ë”°ë¼ í”„ë¡¬í”„íŠ¸ ì„ íƒ
    let finalPrompt = "";

    if (mindMap != null) {
      // âœ… mindMap ë°ì´í„°ê°€ ìˆì„ ê²½ìš° (ë…¸ë“œ ìƒì„± ìš”ì²­)
      finalPrompt = `
      ì´ ìŒì„± í…ìŠ¤íŠ¸ëŠ” íšŒì˜ ì¤‘ ê¸°ë¡ëœ ëŒ€í™”ì…ë‹ˆë‹¤. ë˜í•œ ì•„ë˜ì˜ ë§ˆì¸ë“œë§µ ë…¸ë“œëŠ” íšŒì˜ ì¤‘ ì‘ì„±ëœ ë…¸ë“œì…ë‹ˆë‹¤.

      ë§ˆì¸ë“œë§µ ë…¸ë“œì˜ í…ìŠ¤íŠ¸ë¥¼ í‚¤ì›Œë“œë¡œ ê³ ë ¤í•˜ê³ , ìŒì„± í…ìŠ¤íŠ¸ì˜ ë‚´ìš©ì„ ë°˜ì˜í•˜ì—¬ **ìƒˆë¡­ê²Œ ì¶”ê°€í•  ë§Œí•œ ë…¸ë“œë¥¼ ìµœëŒ€ 2ê°œê¹Œì§€ë§Œ** ìƒì„±í•´ì£¼ì„¸ìš”.

      ìŒì„± í…ìŠ¤íŠ¸:
      ${prompt}

      ë§ˆì¸ë“œë§µ ë…¸ë“œ:
      ${mindMap}


      ì‘ë‹µì€ ì•„ë˜ í˜•ì‹ìœ¼ë¡œ ë°˜í™˜í•´ì£¼ì„¸ìš”:
      ---
      ### ì¶”ê°€í•  ë…¸ë“œ (ìµœëŒ€ 2ê°œ)
      - [ë…¸ë“œ1]
      - [ë…¸ë“œ2] (ë…¸ë“œê°€ 2ê°œ ë¯¸ë§Œì´ë©´ ì ì ˆí•œ ê°œìˆ˜ë§Œ ë°˜í™˜)
      `;
    } else {
      // âœ… mindMap ë°ì´í„°ê°€ ì—†ì„ ê²½ìš° (ê¸°ë³¸ íšŒì˜ë¡ ìƒì„±)
      finalPrompt = `
      ì´ ìŒì„± í…ìŠ¤íŠ¸ëŠ” íšŒì˜ ì¤‘ ê¸°ë¡ëœ ëŒ€í™”ì…ë‹ˆë‹¤. í•œêµ­ì–´ë¡œ ì‘ë‹µí•´ì£¼ì„¸ìš”.

      ### ğŸ“ **ëª©í‘œ**
      - **ìŒì„± í…ìŠ¤íŠ¸ë¥¼ ë¶„ì„í•˜ì—¬ íšŒì˜ì˜ ëª©ì ì„ íŒŒì•…**í•˜ì„¸ìš”.

      ### ğŸ” **ì…ë ¥ ë°ì´í„°**

      #### **í™”ì ëª©ë¡**
      ${speakerNames}

      #### **ìŒì„± í…ìŠ¤íŠ¸**
      ${prompt}

      --- 

      ### **ğŸ“Œ ì‘ì—… ë‚´ìš©**
      1. **SRT ìŒì„± í…ìŠ¤íŠ¸ íŒŒì¼ì„ ìì—°ìŠ¤ëŸ½ê²Œ ìˆ˜ì •í•´ì£¼ì„¸ìš”.(ìƒˆë¡œìš´ ë‚´ìš© ì°½ì‘ì€ ì•ˆë©ë‹ˆë‹¤!!)**
      2. **SRT ìŒì„± í…ìŠ¤íŠ¸ íŒŒì¼ì—ì„œ 1,2ë“±ì˜ ë°œì–¸ ìˆœì„œë¥¼ ë‚˜íƒ€ë‚´ëŠ” ìˆ«ìëŠ” ìƒëµí•´ì£¼ì„¸ìš”.**
      3. **SRT íŒŒì¼ì„ ê¸°ë°˜ìœ¼ë¡œ íšŒì˜ë¡ì„ ì‘ì„±í•˜ì„¸ìš”:**
        - ** 'A:,B:' ë“± í˜•ì‹ì˜ í™”ìë¥¼ í™”ìëª©ë¡ìœ¼ë¡œ ë°”ê¿”ì£¼ì„¸ìš”. (A: -> speakerNames[0], B: -> speakerNAmes[1])** 
        - **íšŒì˜ ëª©ì **
        - **ì£¼ìš” ì£¼ì œ**
        - **ë‹¤ìŒ í•  ì¼**
        - **ìš”ì•½**
        - **í‚¤ì›Œë“œ**

        
      ì‘ë‹µì€ ì•„ë˜ í˜•ì‹ìœ¼ë¡œ ë°˜í™˜í•´ì£¼ì„¸ìš”:
      ---
      ### SRT íŒŒì¼:
      <SRT ë‚´ìš©>

      ### íšŒì˜ë¡:
      **ì£¼ìš” ì£¼ì œ**
        [ë‚´ìš©]

      **ë‹¤ìŒ í•  ì¼**
        [ë‚´ìš©]

      **ìš”ì•½**
        [ê°„ë‹¨í•œ ìš”ì•½ ë‚´ìš©]

      ### í‚¤ì›Œë“œ:

      ** ì£¼ìš” í‚¤ì›Œë“œ**
        [í‚¤ì›Œë“œ ëª©ë¡]

        `;
    }

    // OpenAI API í˜¸ì¶œ
    const response = await openai.chat.completions.create({
      model: "gpt-4", // ë˜ëŠ” "gpt-3.5-turbo"
      messages: [{ role: "user", content: finalPrompt }],
      max_tokens: 1000,
    });

    console.log("OpenAI ì‘ë‹µ:", response.choices[0].message.content);

    return response.choices[0].message.content;
  } catch (error) {
    console.error("ì˜¤ë¥˜ ë°œìƒ:", error);
  }
}

module.exports = { askOpenAI };
